<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Counter Albion</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <header>
      <h2 id="title">Counter Albion</h2>
      <div id="metaSmall" class="meta hint-idle">Mode Voir : clique une arme pour afficher ses relations.</div>
    </header>
    <div id="controls">
      <button id="modeView" class="mode-active">👁️ Voir</button>
      <button id="modeAddForce">➕ Flèche verte</button>
      <button id="modeAddWeak">➕ Flèche rouge</button>
      <button id="modeDelete">🗑️ Supprimer flèche</button>
      <button id="exportBtn">📤 Export</button>
      <button id="importBtn">📥 Import</button>
      <label class="inline">Thème
        <select id="themeSelect">
          <option value="albion-dark">Albion Dark</option>
          <option value="albion-copper">Albion Copper</option>
          <option value="albion-parchment">Albion Parchment</option>
          <option value="custom">Custom…</option>
        </select>
      </label>
      <input type="color" id="bgColor" value="#0f1115" style="display:none"/>
      <textarea id="exportArea" placeholder="Code JSON (export/import)"></textarea>
    </div>
    <div class="group"><h3>Note (arme sélectionnée)</h3><textarea id="nodeNote" class="big-note" placeholder="Tes notes sur cette arme…"></textarea></div>
    <div id="lists">
      <div class="group"><h3>Forces (avantages)</h3><div id="forces"></div></div>
      <div class="group"><h3>Faiblesses (contres)</h3><div id="weaks"></div></div>
    </div>
  </aside>
  <div id="canvasWrap">
    <div class="legend">Vert = avantage • Rouge = contre<br/><span style="opacity:.8">Molette : zoom</span></div>
    <svg id="meta" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>
  </div>
</div>
<script src="app.js" defer></script>
<script src="toggle-addon.js" defer></script>

<!-- LeftPanel Importer injected -->



































<script>
/* IMPORTER_RESTORE_AND_SELECT */
(function(){
  // ---- guard: run once ----
  if (window.__IMPORTER_BUNDLE__) return; window.__IMPORTER_BUNDLE__ = true;

  // ---- helpers ----
  const qs = (sel, root=document) => root.querySelector(sel);
  const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const log = (...a)=>{ try{ console.debug('[Importer]', ...a); }catch(e){} };
  const outlog = (msg)=>{ const pre = qs('.importer-wrap .importer-out'); if(pre){ pre.style.display='block'; pre.textContent = (pre.textContent? pre.textContent+'\n':'') + msg; } };

  function pickHost(){
    return qs('[data-panel="left"]') || qs('#left-panel') || qs('.left-panel') || qs('#sidebar') || qs('.sidebar') || qs('aside') || document.body;
  }

  function ensureFab(){
    if (qs('#importer-fab')) return;
    const fab = document.createElement('button');
    fab.id = 'importer-fab';
    fab.textContent = 'Importer';
    Object.assign(fab.style, {
      position:'fixed', left:'10px', bottom:'10px', zIndex:99999,
      background:'color-mix(in oklab, currentColor 12%, transparent)', color:'inherit',
      border:'1px solid color-mix(in oklab, currentColor 25%, transparent)',
      borderRadius:'999px', padding:'.4rem .7rem', font:'inherit', cursor:'pointer'
    });
    fab.onclick = ()=> {
      const ui = qs('.importer-wrap');
      if (ui) { ui.scrollIntoView({behavior:'smooth', block:'start'}); ui.style.outline='1px dashed color-mix(in oklab, currentColor 35%, transparent)'; setTimeout(()=>ui.style.outline='', 1200); }
      else mountImporter(true);
    };
    document.body.appendChild(fab);
  }

  function createUI(){
    const wrap = document.createElement('div');
    wrap.className = 'importer-wrap importer-inherit';
    wrap.innerHTML = `
      <div class="importer-title" style="font-weight:600;opacity:.9;margin-bottom:.25rem">Importer un build Albion</div>
      <div class="importer-row" style="display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center">
        <input class="importer-input" type="url" placeholder="https://albiononline.com/characterbuilder/solo-builds/view/199739"
               style="width:100%;font:inherit;color:inherit;background:color-mix(in oklab, currentColor 9%, transparent);
                      border:1px solid color-mix(in oklab, currentColor 25%, transparent);border-radius:.5rem;padding:.5rem .75rem">
        <button class="importer-go" type="button"
                style="font:inherit;color:inherit;cursor:pointer;background:color-mix(in oklab, currentColor 12%, transparent);
                       border:1px solid color-mix(in oklab, currentColor 25%, transparent);border-radius:.5rem;padding:.5rem .75rem">Importer</button>
      </div>
      <div class="importer-hint" style="margin-top:.25rem;opacity:.6;font-size:.85em">API : <code>python tools/api_server.py</code></div>
      <pre class="importer-out" style="margin-top:.5rem;background:color-mix(in oklab, currentColor 9%, transparent);color:inherit;border:1px dashed color-mix(in oklab, currentColor 25%, transparent);border-radius:.5rem;padding:.5rem;white-space:pre-wrap;display:none"></pre>
    `;
    return wrap;
  }

  async function callScrape(url){
    const res = await fetch('/api/scrape', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url })});
    return await res.json();
  }

  function mountImporter(forceAttach=false){
    // keep only one
    const existing = qs('.importer-wrap');
    if (existing && !forceAttach) { log('déjà présent'); return existing; }
    // remove stray duplicates
    qsa('.importer-wrap').slice(1).forEach(n=>n.remove());

    const host = pickHost();
    const ui = createUI();
    (host||document.body).insertBefore(ui, host?host.firstChild:null);

    // theme inherit
    ui.style.background = 'inherit';
    ui.style.color = 'inherit';
    ui.style.border = '1px solid color-mix(in oklab, currentColor 20%, transparent)';
    ui.style.borderRadius = '.75rem';
    ui.style.padding = '.5rem';
    ui.style.boxShadow = 'none';

    // wire
    const input = qs('.importer-input', ui);
    const btn   = qs('.importer-go', ui);
    const out   = qs('.importer-out', ui);
    const hint  = qs('.importer-hint', ui);

    btn.addEventListener('click', async()=>{
      const v = (input.value || '').trim();
      if (!/^https?:\/\//i.test(v)) { alert('Colle une URL valide.'); return; }
      out.style.display='block'; out.textContent='Import en cours…';
      try{
        const json = await callScrape(v);
        if(!json.ok) throw new Error(json.error||'Échec import');
        const build = json.build || {};
        const code = (build.gear && build.gear.weapon_code) || '';
        if(code){
          const id8 = code.replace(/^T[1-7]_/, 'T8_');
          const ok = window.App && typeof window.App.selectWeaponById==='function'
            ? await window.App.selectWeaponById(id8) : false;
          out.textContent = `Arme (code): ${code} → ${id8}\nSélection ${ok?'OK':'non confirmée'}.`;
          hint.textContent = 'OK — via API (code).';
        } else {
          const name = (build.gear && build.gear.weapon) || (build.meta && build.meta.title) || '';
          out.textContent = `Arme (nom): ${name}\nUtilise le mapping si besoin.`;
          hint.textContent = 'OK — via API (nom).';
        }
      }catch(e){
        out.textContent = String(e);
        hint.textContent = 'API locale indisponible.';
      }
    });

    return ui;
  }

  // ---- Robust selector hook (same as previous, but included here) ----
  if (!window.__SELECTOR_HOOK__){
    window.__SELECTOR_HOOK__ = true;
    function fireMouse(el){
      const opts={bubbles:true,cancelable:true,view:window};
      try{ el.dispatchEvent(new MouseEvent('pointerdown',opts)); }catch(e){}
      try{ el.dispatchEvent(new MouseEvent('mousedown',opts)); }catch(e){}
      try{ el.dispatchEvent(new MouseEvent('mouseup',opts)); }catch(e){}
      try{ el.dispatchEvent(new MouseEvent('click',opts)); }catch(e){}
    }
    function tierVariants(code){ const tail=(''+code).replace(/^T[1-8]_/, ''); const a=[]; for(let t=8;t>=1;t--) a.push('T'+t+'_'+tail); return a; }
    function findCentralEl(code){
      const sels=[
        `[data-weapon-id="${code}"]`,`[data-id="${code}"]`,`[data-tip="${code}"]`,`[data-item="${code}"]`,`[data-name="${code}"]`,
        `.build-item-main-image img[data-tip="${code}"]`,`.build-item-main img[data-tip="${code}"]`,
        `.items_browser__abilities_main_image[data-tip="${code}"]`,
        `img[src$="/${code}.png"]`,`img[src*="/${code}.png"]`,`img[src*="${code}"]`,`img[alt*="${code}"]`,`img[title*="${code}"]`
      ];
      const hosts=[qs('.build-item-main'),qs('.build-item-container'),qs('[data-panel="center"]'),qs('.center-panel'),qs('.content'),document.body];
      for(const host of hosts){ if(!host) continue; for(const s of sels){ const el = qs(s, host); if(el) return el; } }
      return null;
    }
    window.App = window.App || {};
    window.App.selectWeaponById = async function(id){
      const raw=(''+id).trim().replace(/\.png$/i,'');
      const variants=tierVariants(raw);
      // quick try
      for(const code of variants){
        const el=findCentralEl(code);
        if(el){ try{ el.scrollIntoView({behavior:'smooth',block:'center'});}catch(e){} fireMouse(el); outlog('Clique immédiat : '+code); return true; }
      }
      // retry 5s
      return await new Promise((resolve)=>{
        const start=Date.now();
        function attempt(tag){
          for(const code of variants){
            const el=findCentralEl(code);
            if(el){ try{ el.scrollIntoView({behavior:'smooth',block:'center'});}catch(e){} fireMouse(el); outlog('Clique '+tag+' : '+code); resolve(true); return true; }
          }
          return false;
        }
        const obs=new MutationObserver(()=>attempt('différé'));
        obs.observe(document.documentElement,{childList:true,subtree:true,attributes:true});
        const timer=setInterval(()=>{
          if(attempt('retry')){ clearInterval(timer); obs.disconnect(); return; }
          if(Date.now()-start>5000){ clearInterval(timer); obs.disconnect(); outlog('Échec sélection (timeout)'); resolve(false); }
        }, 200);
      });
    };
  }

  // ---- mount now + resilience ----
  function boot(){ ensureFab(); mountImporter(); }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
  // if the sidebar DOM gets replaced, re-mount our single block
  const mo=new MutationObserver(()=>{ if(!document.querySelector('.importer-wrap')) mountImporter(true); });
  mo.observe(document.body,{childList:true,subtree:true});
})();
</script>

</body>
</html>
